<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha512-DUC8yqWf7ez3JD1jszxCWSVB0DMP78eOyBpMa5aJki1bIRARykviOuImIczkxlj1KhVSyS16w2FSQetkD4UU2w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        function postPurchase(newHeight, callback) {
            try {
                console.log(`-----------postPurchase сработал`)
                parent.postMessage('Привет из айфрейма', '*')
                parent.postPurchase('Привет это Purchase', '*')
        
                // если виджет открывается внутри iframe
                // if (
                //     typeof Config !== "undefined" &&
                //     Config.domain &&
                //     dataLayer?.length > 0
                // ) {
                //     let purchaseObj = dataLayer?.find((obj) => obj?.event === 'purchase')
                //     console.log('postPurchase obj = ', purchaseObj)
                //     if (purchaseObj) {
        
                //         parent.postMessage(JSON.stringify(purchaseObj), Config.domain)
                //     }
                // }
                setTimeOut( () => parent.postMessage('Привет из айфрейма setTimeOut', '*'), 2000)
            } catch(e) {
                console.log('ошибка в postMessage.js', e)
            }
        }

    ;(function () {
    "use strict"

    $(document).ready(function () {
            console.log('this.contentWindow = ', this.contentWindow)
            this.contentWindow.addEventListener(
                "purchase",
                function (message) { 
                    alert(message)
                    try{
                        console.log('addEventListener слушатель purchase СРАБОТАЛ!')
                        var data = JSON.parse(message.data);
                        var dataLayer = window.dataLayer || (window.dataLayer = []);
                    if (data.event) {
                        dataLayer.push({
                            ...data
                        })}
                    } catch (e) {console.log('ошибка в eventListener postMessage.js', e)}
                },
                true
            )
            this.contentWindow.addEventListener(
                "message",
                function (message) { alert(message) },
                true
            )

        )
        postPurchase() // отправляем событие purchase на сайт в котором установлен iframe
    })
})()
</script>
<!--     <script src="https://tickets.kassir.ru/widget/widget-container.js"></script> -->
<!-- Этот скрипт загрузки iframe работает  -->
<!--     <script src="https://msk.kassir.ru/start-frame.js"></script> -->
<!--     <script src="https://spb.web.test.kassir.ru/start-frame.js"></script> -->
</head>
<body>
<!--     <h1>Страница для тестирования iframe spb.web.test</h1> -->
<!--     <a href="https://crocus2.kassir.ru/widget/?key=3166df32-f9f2-e729-a9de-db7b70d39c68&eventId=1203169" class="widget-tr">Купить билет</a> -->

    <!-- <a href="https://msk.kassir.ru/frame/entry/index?key=2b7a953a-ecee-bee9-8995-a78336b25ba8&amp;type=E&amp;id=1554524" onclick="return window.kassirWidget.summon()" target="_blank" class="widget-tr redbutton">Купить билет &gt;</a> -->
    <h1> Это окно iframe 2</h1>
    <button onclick="console.log('click')">Клик</button>
    <!-- <a href="https://spb.web.test.kassir.ru/frame/entry/index?key=b5d795aa-b069-8861-9996-1e18d7e92b7d" onclick="return window.kassirWidget.summon()" target="_blank" class="widget-tr redbutton">Купить билет &gt;</a> -->
</body>
</html>
